name: AuCore IG go-publish

on:
  push:
    branches: [ "feature/cicd" ]
  pull_request:
    branches:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container: hl7fhir/ig-publisher-base    # use ig publisher base image
    steps:
    - name: Checkout AU Core Repository
      uses: actions/checkout@v4

    - name: Update Publisher
      run: |
        _updatePublisher.sh -f -y

    # - name: Basic Publisher build
    #   run: |
    #     _genonce.sh

    - name: Run Complex Publisher build
      run:  java -jar input-cache/publisher.jar -go-publish -ig ig.ini -source . # -web (full path to webroot) -registry (full path to fhir-ig-list.json) -history (full path to ig-history) -templates (full path to templates)
      ## information on proper use in confluence but not in github https://confluence.hl7.org/pages/viewpage.action?pageId=104580055 might be outdated? https://github.com/HL7/fhir-ig-publisher/commit/6b77ac64637ee485a4984cf2e1d7a7a999a27c80

    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: ig-output
        path: output/full-ig.zip # full ig zip is 1/10 the size but has all relevant content?

    - name: ðŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{secrets.BUILD_SERVER}} # change to be env variable to support multiple environments later on
        username: ${{ secrets.FTP_USER }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: output/
        server-dir: /ig/hl7au/au-fhir-core/branches/${{ github.ref }}/gopublish/
        dry-run: true